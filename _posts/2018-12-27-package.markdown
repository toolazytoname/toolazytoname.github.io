---

layout: post
title:  "iOSè‡ªåŠ¨æ‰“åŒ…"
date:   2018-12-27 18:09:32 +0800
categories: iOS
catalog:  true
tags:
  - iOS 
---



# æ•ˆæœ

1. ç»“åˆJenkinså¯ä»¥æä¾›å¦‚ä¸‹åŠŸèƒ½

   1. æµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡æµè§ˆå™¨æ“ä½œ
   2. å¯ä»¥æ‰“ä¸é€šåˆ†æ”¯çš„åŒ…
   3. å¯ä»¥å®šæ—¶è§¦å‘
   4. æ‰“åŒ…å®Œæˆå¯ä»¥å‘é‚®ä»¶é€šçŸ¥
      1. é‚®ä»¶å¯ä»¥å¸¦å·¥ç¨‹ç›®å½•çš„podfile.lockä¸ºé™„ä»¶
      2. é‚®ä»¶å†…å®¹å¯å®šåˆ¶ï¼Œå¸¦ä¸Šäº†è¿›è¿‡æ­£åˆ™ç­›é€‰çš„æ—¥å¿—å†…å®¹

2. é€šè¿‡è„šæœ¬

   1. æ‰“åŒ…å‰è‡ªåŠ¨æ‹‰å–è¿œç«¯Podfileè¦†ç›–æœ¬åœ°æ–‡ä»¶(å’Œå·¥ç¨‹ç›®å½•åˆ†å¼€ç®¡ç†)

   2. pod update

   3. è‡ªåŠ¨ä¸Šä¼ è’²å…¬è‹±

   4. å¤‡ä»½äº†

      1. .xcarchiveæ–‡ä»¶å¤¹

      2. ipa æ–‡ä»¶

      3. Podfile

      4. podfile.lock.




## å·¥ä½œç›®å½•ç»“æ„

å°†Package æ”¾åˆ°å½“å‰å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ã€‚



* Package

  * package.shï¼ˆæ‰“åŒ…è„šæœ¬ï¼‰

  * plist

    *   app-store.plist
    *   enterprise.plist

  * build

    *   xxxxxx2018-12-27-14/59/08.xcarchive
    *   xxxxxx2018-12-27-15/22/33.xcarchive

  * IPADir

    *   Release
        *   2018-12-27-16/16/29
            *   xxxxxx.ipa
            *   DistributionSummary.plist
            *   ExportOptions.plist
            *   Packaging.log
            *   Podfile
            *   podfile.lock




# æºç 

~~~shell
#!/bin/sh
# è¯¥è„šæœ¬ä½¿ç”¨æ–¹æ³•
# æºç åœ°å€ï¼š
# step 1. åœ¨å·¥ç¨‹æ ¹ç›®å½•æ–°å»ºPackageæ–‡ä»¶å¤¹ï¼Œpackage.shæ”¾è¿›å»;
# step 2. è®¾ç½®è¯¥è„šæœ¬;
# step 2. cd è¯¥è„šæœ¬ç›®å½•ï¼Œè¿è¡Œchmod +x package.sh;
# step 3. ç»ˆç«¯è¿è¡Œ sh package.sh;
# step 4. é€‰æ‹©ä¸åŒé€‰é¡¹....
# step 5. Success  ğŸ‰ ğŸ‰ ğŸ‰!


# ************************* éœ€è¦é…ç½® Start ********************************

#podfileçš„è·¯å¾„
Podfile_URL=http://gitlabXXXXXXXXX/master/Podfile

# ã€é…ç½®ä¸Šä¼ åˆ°è’²å…¬è‹±ç›¸å…³ä¿¡æ¯ã€‘(å¯é€‰)
__PGYER_U_KEY="db4XXXXXXXXXXXXXXXXXXXXXXXXXXX"
__PGYER_API_KEY="afXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# å‘å¸ƒAPP Store è´¦å·å¯†ç 
__IOS_SUBMIT_ACCOUNT="apple id"
__IOS_SUBMIT_PASSWORD="xxxxxx"

#å·¥ç¨‹å
project_name=XXXXXXXXX

#schemeå
scheme_name=XXXXXXXXX

#æ‰“åŒ…æ¨¡å¼ Debug/Release
development_mode=Release

#buildæ–‡ä»¶å¤¹è·¯å¾„
build_path=${project_path}/Package/build

#å½’æ¡£æ–‡ä»¶ç›®å½•
BUILD_DATETIME=`date '+%Y-%m-%d-%H:%M:%S'`
archivePath=${build_path}/${project_name}${BUILD_DATETIME}.xcarchive

#plistæ–‡ä»¶æ‰€åœ¨è·¯å¾„
exportOptionsPlistPath=${project_path}/Package/plist/enterprise.plist

#å¯¼å‡º.ipaæ–‡ä»¶æ‰€åœ¨è·¯å¾„
exportIpaPath=${project_path}/Package/IPADir/${development_mode}/${BUILD_DATETIME}
# ************************* éœ€è¦é…ç½® end ********************************

#å·¥ç¨‹ç»å¯¹è·¯å¾„
project_path=$(cd `dirname $0`; pwd)
cd ../

echo "Place enter the number you want to export ? [ 1:app-store 2:enterprise] "
read number

# number=2
while([[ $number != 1 ]] && [[ $number != 2 ]])
do
echo "Error! Should enter 1 or 2"
echo "Place enter the number you want to export ? [ 1:app-store 2:enterprise] "
read number
done

if [ $number == 1 ];then
# development_mode=Release
scheme_name=XXXXXXXXX
exportOptionsPlistPath=${project_path}/Package/plist/exportAppstore.plist
else
# development_mode=Release
scheme_name=XXXXXXXXX
exportOptionsPlistPath=${project_path}/Package/plist/enterprise.plist
fi

echo '///-----------'
echo '/// update Podfile '
echo '///-----------'
curl ${Podfile_URL} > Podfile

echo '///-----------'
echo '/// pod update'
echo '///-----------'
pod update

echo '///-----------'
echo '/// æ­£åœ¨æ¸…ç†å·¥ç¨‹'
echo '///-----------'
xcodebuild \
clean -configuration ${development_mode} -quiet  || exit

echo '///--------'
echo '/// æ¸…ç†å®Œæˆ'
echo '///--------'
echo ''

echo '///-----------'
echo '/// æ­£åœ¨ç¼–è¯‘å·¥ç¨‹:'${development_mode}
echo '///-----------'
xcodebuild \
archive -workspace ${project_path}/${project_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${development_mode} \
-archivePath ${archivePath}  -quiet  || exit

echo '///--------'
echo '/// ç¼–è¯‘å®Œæˆ'
echo '///--------'
echo ''

echo '///----------'
echo '/// å¼€å§‹ipaæ‰“åŒ…'
echo '///----------'
xcodebuild -exportArchive -archivePath ${archivePath} \
-configuration ${development_mode} \
-exportPath ${exportIpaPath} \
-exportOptionsPlist ${exportOptionsPlistPath} \
-quiet || exit

if [ -e $exportIpaPath/$scheme_name.ipa ]; then
echo '///----------'
echo '/// ipaåŒ…å·²å¯¼å‡º'
echo '///----------'
else
echo '///-------------'
echo '/// ipaåŒ…å¯¼å‡ºå¤±è´¥ '
echo '///-------------'
fi
echo '///------------'
echo '/// æ‰“åŒ…ipaå®Œæˆ  '
echo '///-----------='
echo ''

echo '///-------------'
echo '/// å¼€å§‹å‘å¸ƒipaåŒ… '
echo '///-------------'

if [ $number == 1 ];then

#éªŒè¯å¹¶ä¸Šä¼ åˆ°App Store
altoolPath="/Applications/Xcode.app/Contents/Applications/Application Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Versions/A/Support/altool"
"$altoolPath" --validate-app -f ${exportIpaPath}/${scheme_name}.ipa -u ${__IOS_SUBMIT_ACCOUNT} -p ${__IOS_SUBMIT_PASSWORD} -t ios --output-format xml
"$altoolPath" --upload-app -f ${exportIpaPath}/${scheme_name}.ipa -u  ${__IOS_SUBMIT_ACCOUNT} -p ${__IOS_SUBMIT_PASSWORD} -t ios --output-format xml
else

# ä¸Šä¼ è’²å…¬è‹±
curl -F "file=@$exportIpaPath/$scheme_name.ipa" \
   -F "uKey=$__PGYER_U_KEY" \
   -F "_api_key=$__PGYER_API_KEY" \
   "http://www.pgyer.com/apiv1/app/upload"
   
echo "ä¸Šä¼  ${exportIpaPath}/${scheme_name}.ipa åŒ… åˆ° pgyer æˆåŠŸ ğŸ‰ ğŸ‰ ğŸ‰"

fi

echo '///-------------'
echo '/// å¼€å§‹å¤‡ä»½Podfile åˆ°'${exportIpaPath}
echo '///-------------'

cp Podfile ${exportIpaPath}
cp podfile.lock  ${exportIpaPath}

echo '///-------------'
echo '/// å¤‡ä»½Podfileå®Œæˆ'
echo '///-------------'
exit 0

~~~



# jerkins è®¾ç½®

## æ„å»ºæ‰§è¡Œshell

 ~~~shell

sh Package/package.sh
 ~~~



## æ„å»ºå‡ºå‘å™¨

~~~
0 9 * * *
0 11 * * *
0 13 * * *
0 15 * * *
0 17 * * *
0 19 * * *
0 21 * * *
~~~



## Editable Email Notification

Default Subject

~~~sh
$DEFAULT_SUBJECT
~~~

Default Content

~~~html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${ENV, var="JOB_NAME"}-ç¬¬${BUILD_NUMBER}æ¬¡æ„å»ºæ—¥å¿—</title>
</head>
<body leftmargin="8" marginwidth="0" topmargin="8" marginheight="4" offset="0">
<table width="95%" cellpadding="0" cellspacing="0" style="font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif">
<tr>
   <td>(æœ¬é‚®ä»¶æ˜¯ç¨‹åºè‡ªåŠ¨ä¸‹å‘çš„ï¼Œè¯·å‹¿å›å¤ï¼)</td>
</tr>
<tr>
   <td><h2><font color="#0000FF">æ„å»ºç»“æœ - ${BUILD_STATUS}</font></h2></td>
</tr>
<tr>
   <td><br /> <b><font color="#0B610B">æ„å»ºä¿¡æ¯</font></b> <hr size="2" width="100%" align="center" /></td> 
</tr> 
<tr>
<td> 
     <ul> 
          <li>é¡¹ç›®åç§°&nbsp;ï¼š&nbsp;${PROJECT_NAME}</li>
          <li>æ„å»ºç¼–å·&nbsp;ï¼š&nbsp;ç¬¬${BUILD_NUMBER}æ¬¡æ„å»º</li>
          <li>è§¦å‘åŸå› ï¼š&nbsp;${CAUSE}</li>
          <li>æ„å»ºæ—¥å¿—ï¼š&nbsp;<a href="${BUILD_URL}console">${BUILD_URL}console</a></li>
          <li>æ„å»º&nbsp;&nbsp;Url&nbsp;ï¼š&nbsp;<a href="${BUILD_URL}">${BUILD_URL}</a></li>
          <li>å·¥ä½œç›®å½•&nbsp;ï¼š&nbsp;<a href="${PROJECT_URL}ws">${PROJECT_URL}ws</a></li>
          <li>é¡¹ç›®&nbsp;&nbsp;Url&nbsp;ï¼š&nbsp;<a href="${PROJECT_URL}">${PROJECT_URL}</a></li>
<li>ä¸‹è½½åœ°å€ï¼š <a href="https://www.pgyer.com/bitautoplus">è’²å…¬è‹±</a></li> 
     </ul> 
</td> 
</tr>
<tr>
     <td><b><font color="#0B610B">ç‰ˆæœ¬å·</font></b> <hr size="2" width="100%" align="center" /></td>
</tr>
<tr>
<td>
     <span>${BUILD_LOG_MULTILINE_REGEX,showTruncatedLines="false",regex="Pre-downloading: `(.*)"} </span>
</td> 
</tr>
</table>
</body>
</html>
~~~



Attachments



~~~
Podfile.lock
~~~



# ç¢°åˆ°çš„é—®é¢˜

ç¢°åˆ°çš„é—®é¢˜æ˜¯pod update çš„è¿‡ç¨‹å½“ä¸­ï¼ŒPre-downloading 

~~~
Pre-downloading: `xxxLib` from `http://gitlab.xxxxxxxxxxxxb.git`, tag `0.4.5`

[!] Error installing xxxLib
[!] Failed to download 'xxxLib'.
~~~

ä½†æ˜¯æˆ‘è¿œç¨‹ç™»å½•åˆ°æœåŠ¡å™¨	

~~~shell
cd  ~/.jenkins/jobs/iOSxxxxx/workspace
pod update --verbose
~~~

æ‰“å°å‡ºæ¥çš„æ—¥å¿—

~~~
  > Copying xxxxxxMessageCenterLib from `/Users/yiche/Library/Caches/CocoaPods/Pods/External/xxxxxxMessageCenterLib/ac0999518905dfaeb4412e75cb70102e` to `Pods/xxxxxxMessageCenterLib`
-> Pre-downloading: `xxxxxxNewsLib` from `http://gitlab.xxxxxx.com/WP/Mobile/IOS/xxxxxxNewsLib.git`, tag `0.4.5`
 > Git download
 > Git download
     $ /usr/bin/git clone http://gitlab.xxxxxx.com/WP/Mobile/IOS/xxxxxxNewsLib.git /var/folders/7w/q65n0jy56nq42f3k0nlfnbm00000gn/T/d20181228-23832-zemqsr --template= --single-branch --depth 1 --branch 0.4.5
     Cloning into '/var/folders/7w/q65n0jy56nq42f3k0nlfnbm00000gn/T/d20181228-23832-zemqsr'...
     Note: checking out 'a6be63cbda94bd367394c9f392b94a2a793b3b6d'.
     
     You are in 'detached HEAD' state. You can look around, make experimental
     changes and commit them, and you can discard any commits you make in this
     state without impacting any branches by performing another checkout.
     
     If you want to create a new branch to retain commits you create, you may
     do so (now or later) by using -b with the checkout command again. Example:
     
       git checkout -b <new-branch-name>
     
     Checking out files:  97% (6302/6496)   
     Checking out files:  98% (6367/6496)   
     Checking out files:  99% (6432/6496)   
     Checking out files: 100% (6496/6496)   
     Checking out files: 100% (6496/6496), done.
[!] Error installing xxxxxxNewsLib
[!] Failed to download 'xxxxxxNewsLib'.
~~~

è™½ç„¶ç”¨åˆ°çš„æ–‡ä»¶æ˜¯7Mï¼Œä½†æ˜¯pod update ä¼šæŠŠæ•´ä¸ªç›®å½•éƒ½ç»™æ‹‰ä¸‹æ¥ï¼Œä¸€æ•´ä¸ªç›®å½•ä¸€ä¸ªå¤šGï¼Œå½“ç„¶ä¼šå¤±è´¥äº†ï¼Œåç»­ç»§ç»­è§‚å¯Ÿï¼Œè§‚å¯Ÿã€‚



## å‚è€ƒ

1. [AutoPacking-iOS](https://github.com/stackhou/AutoPacking-iOS)
2. [archiveScript](https://github.com/kepuna/archiveScript)


